<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>膝前十字靭帯再建術後選手における膝関節等速性筋力とカウンタームーブメントジャンプ指標の関係</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 500px; /* Adjust height for larger screens */
            }
        }

        .heatmap-cell {
            flex-shrink: 0; /* Prevents cells from shrinking on small screens */
            width: 100px;
            height: 60px;
            margin: 2px;
            text-align: center;
            line-height: 60px;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .tab-button {
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            background: transparent;
            white-space: nowrap; /* Prevents text wrapping */
        }

        .tab-button.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tab-button:not(.active) {
            color: #6b7280;
        }

        .tab-button:not(.active):hover {
            color: #111827;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        /* Custom scrollbar for better mobile feel */
        .overflow-x-scroll::-webkit-scrollbar {
            height: 8px;
        }

        .overflow-x-scroll::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 4px;
        }

        .overflow-x-scroll::-webkit-scrollbar-track {
            background-color: #f3f4f6;
            border-radius: 4px;
        }
    </style>
    <script>
        const data = [{"ID": "A", "Side": "Non", "Ope": "ACLR_STG", "Competition": "格闘技系", "Gender": "M", "伸展（60deg/sec)": 4.179487179, "伸展（180deg/sec)": 2.897435897, "屈曲（60deg/sec)": 1.731623932, "屈曲（180deg/sec)": 1.362393162, "跳躍高(片脚)": 24.1, "滞空時間(片脚)": 0.48, "減速局面力積(片脚)": 1.14, "推進局面力積(片脚)": 2.26, "減速局面力積(両足)": 0.82, "推進局面力積(両足)": 1.72}, {"ID": "A", "Side": "Injured", "Ope": "ACLR_STG", "Competition": "格闘技系", "Gender": "M", "伸展（60deg/sec)": 3.358974359, "伸展（180deg/sec)": 2.362393162, "屈曲（60deg/sec)": 1.682051282, "屈曲（180deg/sec)": 1.34017094, "跳躍高(片脚)": 17.65, "滞空時間(片脚)": 0.41, "減速局面力積(片脚)": 1.12, "推進局面力積(片脚)": 1.93, "減速局面力積(両足)": 0.73, "推進局面力積(両足)": 1.34}, {"ID": "B", "Side": "Non", "Ope": "ACLR_BTB", "Competition": "スキー/スノーボード", "Gender": "M", "伸展（60deg/sec)": 3.472222222, "伸展（180deg/sec)": 2.451388889, "屈曲（60deg/sec)": 1.670833333, "屈曲（180deg/sec)": 1.354166667, "跳躍高(片脚)": 23.39, "滞空時間(片脚)": 0.48, "減速局面力積(片脚)": 1.05, "推進局面力積(片脚)": 2.15, "減速局面力積(両足)": 0.79, "推進局面力積(両足)": 1.5}, {"ID": "B", "Side": "Injured", "Ope": "ACLR_BTB", "Competition": "スキー/スノーボード", "Gender": "M", "伸展（60deg/sec)": 2.841666667, "伸展（180deg/sec)": 2.316666667, "屈曲（60deg/sec)": 1.4875, "屈曲（180deg/sec)": 1.376388889, "跳躍高(片脚)": 22.94, "滞空時間(片脚)": 0.48, "減速局面力積(片脚)": 1.09, "推進局面力積(片脚)": 2.14, "減速局面力積(両足)": 0.81, "推進局面力積(両足)": 1.43}, {"ID": "C", "Side": "Non", "Ope": "ACLR_STG", "Competition": "スキー/スノーボード", "Gender": "M", "伸展（60deg/sec)": 3.310751105, "伸展（180deg/sec)": 2.288659794, "屈曲（60deg/sec)": 1.640648012, "屈曲（180deg/sec)": 1.296023564, "跳躍高(片脚)": 21.35, "滞空時間(片脚)": 0.49, "減速局面力積(片脚)": 1.48, "推進局面力積(片脚)": 2.09, "減速局面力積(両足)": 0.97, "推進局面力積(両足)": 1.67}, {"ID": "C", "Side": "Injured", "Ope": "ACLR_STG", "Competition": "スキー/スノーボード", "Gender": "M", "伸展（60deg/sec)": 3.539027982, "伸展（180deg/sec)": 2.552282769, "屈曲（60deg/sec)": 1.583210604, "屈曲（180deg/sec)": 1.309278351, "跳躍高(片脚)": 20.54, "滞空時間(片脚)": 0.42, "減速局面力積(片脚)": 1.29, "推進局面力積(片脚)": 2.05, "減速局面力積(両足)": 0.78, "推進局面力積(両足)": 1.3}, {"ID": "D", "Side": "Non", "Ope": "ACLR_STG", "Competition": "格闘技系", "Gender": "M", "伸展（60deg/sec)": 3.573684211, "伸展（180deg/sec)": 2.697368421, "屈曲（60deg/sec)": 1.748684211, "屈曲（180deg/sec)": 1.35, "跳躍高(片脚)": 24.4, "滞空時間(片脚)": 0.5, "減速局面力積(片脚)": 1.05, "推進局面力積(片脚)": 2.2, "減速局面力積(両足)": 0.62, "推進局面力積(両足)": 1.63}, {"ID": "D", "Side": "Injured", "Ope": "ACLR_STG", "Competition": "格闘技系", "Gender": "M", "伸展（60deg/sec)": 3.339473684, "伸展（180deg/sec)": 2.332894737, "屈曲（60deg/sec)": 1.152631579, "屈曲（180deg/sec)": 0.872368421, "跳躍高(片脚)": 20.19, "滞空時間(片脚)": 0.45, "減速局面力積(片脚)": 1.19, "推進局面力積(片脚)": 2.01, "減速局面力積(両足)": 0.74, "推進局面力積(両足)": 1.33}, {"ID": "E", "Side": "Non", "Ope": "ACLR_STG", "Competition": "スキー/スノーボード", "Gender": "F", "伸展（60deg/sec)": 3.295839753, "伸展（180deg/sec)": 2.18027735, "屈曲（60deg/sec)": 1.311248074, "屈曲（180deg/sec)": 0.973805855, "跳躍高(片脚)": 12.28, "滞空時間(片脚)": 0.35, "減速局面力積(片脚)": 0.97, "推進局面力積(片脚)": 1.59, "減速局面力積(両足)": 0.74, "推進局面力積(両足)": 1.33}, {"ID": "E", "Side": "Injured", "Ope": "ACLR_STG", "Competition": "スキー/スノーボード", "Gender": "F", "伸展（60deg/sec)": 1.927580894, "伸展（180deg/sec)": 1.457627119, "屈曲（60deg/sec)": 1.146379045, "屈曲（180deg/sec)": 0.850539291, "跳躍高(片脚)": 8.3, "滞空時間(片脚)": 0.31, "減速局面力積(片脚)": 0.81, "推進局面力積(片脚)": 1.31, "減速局面力積(両足)": 0.71, "推進局面力積(両足)": 0.97}, {"ID": "F", "Side": "Non", "Ope": "ACLR_BTB", "Competition": "格闘技系", "Gender": "F", "伸展（60deg/sec)": 2.790436006, "伸展（180deg/sec)": 1.901547117, "屈曲（60deg/sec)": 1.340365682, "屈曲（180deg/sec)": 1.029535865, "跳躍高(片脚)": 10.4, "滞空時間(片脚)": 0.34, "減速局面力積(片脚)": 1.0, "推進局面力積(片脚)": 1.46, "減速局面力積(両足)": 0.79, "推進局面力積(両足)": 1.28}, {"ID": "F", "Side": "Injured", "Ope": "ACLR_BTB", "Competition": "格闘技系", "Gender": "F", "伸展（60deg/sec)": 2.450070323, "伸展（180deg/sec)": 1.82278481, "屈曲（60deg/sec)": 1.338959212, "屈曲（180deg/sec)": 0.990154712, "跳躍高(片脚)": 8.51, "滞空時間(片脚)": 0.32, "減速局面力積(片脚)": 1.07, "推進局面力積(片脚)": 1.32, "減速局面力積(両足)": 0.75, "推進局面力積(両足)": 1.07}, {"ID": "G", "Side": "Non", "Ope": "ACLR_BTB", "Competition": "球技系", "Gender": "F", "伸展（60deg/sec)": 3.075, "伸展（180deg/sec)": 2.078846154, "屈曲（60deg/sec)": 1.596153846, "屈曲（180deg/sec)": 1.186538462, "跳躍高(片脚)": 15.29, "滞空時間(片脚)": 0.4, "減速局面力積(片脚)": 1.08, "推進局面力積(片脚)": 1.84, "減速局面力積(両足)": 0.81, "推進局面力積(両足)": 1.43}, {"ID": "G", "Side": "Injured", "Ope": "ACLR_BTB", "Competition": "球技系", "Gender": "F", "伸展（60deg/sec)": 2.413461538, "伸展（180deg/sec)": 1.553846154, "屈曲（60deg/sec)": 1.559615385, "屈曲（180deg/sec)": 1.215384615, "跳躍高(片脚)": 10.93, "滞空時間(片脚)": 0.34, "減速局面力積(片脚)": 1.01, "推進局面力積(片脚)": 1.57, "減速局面力積(両足)": 0.87, "推進局面力積(両足)": 1.19}, {"ID": "H", "Side": "Non", "Ope": "ACLR_STG", "Competition": "格闘技系", "Gender": "F", "伸展（60deg/sec)": 3.297101449, "伸展（180deg/sec)": 2.224637681, "屈曲（60deg/sec)": 1.523550725, "屈曲（180deg/sec)": 1.130434783, "跳躍高(片脚)": 14.32, "滞空時間(片脚)": 0.39, "減速局面力積(片脚)": 1.18, "推進局面力積(片脚)": 1.69, "減速局面力積(両足)": 0.8, "推進局面力積(両足)": 1.3}, {"ID": "H", "Side": "Injured", "Ope": "ACLR_STG", "Competition": "格闘技系", "Gender": "F", "伸展（60deg/sec)": 2.615942029, "伸展（180deg/sec)": 1.737318841, "屈曲（60deg/sec)": 1.065217391, "屈曲（180deg/sec)": 0.875, "跳躍高(片脚)": 10.51, "滞空時間(片脚)": 0.33, "減速局面力積(片脚)": 1.14, "推進局面力積(片脚)": 1.45, "減速局面力積(両足)": 0.73, "推進局面力積(両足)": 1.19}, {"ID": "I", "Side": "Non", "Ope": "ACLR_STG", "Competition": "球技系", "Gender": "F", "伸展（60deg/sec)": 3.089795918, "伸展（180deg/sec)": 1.912244898, "屈曲（60deg/sec)": 1.344897959, "屈曲（180deg/sec)": 0.995918367, "跳躍高(片脚)": 12.63, "滞空時間(片脚)": 0.37, "減速局面力積(片脚)": 1.06, "推進局面力積(片脚)": 1.62, "減速局面力積(両足)": 0.85, "推進局面力積(両足)": 1.36}, {"ID": "I", "Side": "Injured", "Ope": "ACLR_STG", "Competition": "球技系", "Gender": "F", "伸展（60deg/sec)": 2.073469388, "伸展（180deg/sec)": 1.316326531, "屈曲（60deg/sec)": 1.093877551, "屈曲（180deg/sec)": 0.895918367, "跳躍高(片脚)": 6.3, "滞空時間(片脚)": 0.31, "減速局面力積(片脚)": 0.98, "推進局面力積(片脚)": 1.16, "減速局面力積(両足)": 0.67, "推進局面力積(両足)": 0.93}, {"ID": "J", "Side": "Non", "Ope": "ACLR_STG", "Competition": "球技系", "Gender": "F", "伸展（60deg/sec)": 3.137254902, "伸展（180deg/sec)": 2.084313725, "屈曲（60deg/sec)": 1.562745098, "屈曲（180deg/sec)": 1.119607843, "跳躍高(片脚)": 13.04, "滞空時間(片脚)": 0.38, "減速局面力積(片脚)": 0.93, "推進局面力積(片脚)": 1.66, "減速局面力積(両足)": 0.92, "推進局面力積(両足)": 1.23}, {"ID": "J", "Side": "Injured", "Ope": "ACLR_STG", "Competition": "球技系", "Gender": "F", "伸展（60deg/sec)": 2.874509804, "伸展（180deg/sec)": 2.045098039, "屈曲（60deg/sec)": 1.225490196, "屈曲（180deg/sec)": 0.943137255, "跳躍高(片脚)": 11.82, "滞空時間(片脚)": 0.35, "減速局面力積(片脚)": 1.03, "推進局面力積(片脚)": 1.58, "減速局面力積(両足)": 0.76, "推進局面力積(両足)": 1.1}, {"ID": "K", "Side": "Non", "Ope": "ACLR_STG", "Competition": "格闘技系", "Gender": "F", "伸展（60deg/sec)": 3.148325359, "伸展（180deg/sec)": 2.054226475, "屈曲（60deg/sec)": 1.416267943, "屈曲（180deg/sec)": 1.146730463, "跳躍高(片脚)": 9.78, "滞空時間(片脚)": 0.31, "減速局面力積(片脚)": 1.02, "推進局面力積(片脚)": 1.42, "減速局面力積(両足)": 0.87, "推進局面力積(両足)": 1.14}, {"ID": "K", "Side": "Injured", "Ope": "ACLR_STG", "Competition": "格闘技系", "Gender": "F", "伸展（60deg/sec)": 2.88676236, "伸展（180deg/sec)": 1.968102073, "屈曲（60deg/sec)": 1.213716108, "屈曲（180deg/sec)": 0.98245614, "跳躍高(片脚)": 8.2, "滞空時間(片脚)": 0.28, "減速局面力積(片脚)": 1.12, "推進局面力積(片脚)": 1.3, "減速局面力積(両足)": 0.7, "推進局面力積(両足)": 1.03}, {"ID": "L", "Side": "Non", "Ope": "ACLR_BTB", "Competition": "記録系", "Gender": "F", "伸展（60deg/sec)": 3.020689655, "伸展（180deg/sec)": 1.767241379, "屈曲（60deg/sec)": 2.018965517, "屈曲（180deg/sec)": 1.715517241, "跳躍高(片脚)": 20.89, "滞空時間(片脚)": 0.46, "減速局面力積(片脚)": 0.82, "推進局面力積(片脚)": 2.06, "減速局面力積(両足)": 0.61, "推進局面力積(両足)": 1.45}, {"ID": "L", "Side": "Injured", "Ope": "ACLR_BTB", "Competition": "記録系", "Gender": "F", "伸展（60deg/sec)": 2.343103448, "伸展（180deg/sec)": 1.824137931, "屈曲（60deg/sec)": 1.839655172, "屈曲（180deg/sec)": 1.648275862, "跳躍高(片脚)": 18.57, "滞空時間(片脚)": 0.43, "減速局面力積(片脚)": 0.88, "推進局面力積(片脚)": 1.96, "減速局面力積(両足)": 0.58, "推進局面力積(両足)": 1.34}, {"ID": "M", "Side": "Non", "Ope": "ACLR_BTB", "Competition": "球技系", "Gender": "F", "伸展（60deg/sec)": 3.305172414, "伸展（180deg/sec)": 2.35862069, "屈曲（60deg/sec)": 1.510344828, "屈曲（180deg/sec)": 1.170689655, "跳躍高(片脚)": 17.03, "滞空時間(片脚)": 0.39, "減速局面力積(片脚)": 1.21, "推進局面力積(片脚)": 1.93, "減速局面力積(両足)": 1.02, "推進局面力積(両足)": 1.48}, {"ID": "M", "Side": "Injured", "Ope": "ACLR_BTB", "Competition": "球技系", "Gender": "F", "伸展（60deg/sec)": 2.213793103, "伸展（180deg/sec)": 1.75862069, "屈曲（60deg/sec)": 1.255172414, "屈曲（180deg/sec)": 1.032758621, "跳躍高(片脚)": 11.89, "滞空時間(片脚)": 0.32, "減速局面力積(片脚)": 1.03, "推進局面力積(片脚)": 1.61, "減速局面力積(両足)": 0.55, "推進局面力積(両足)": 1.18}] </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div class="max-w-7xl mx-auto p-4 md:p-6">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-6 text-center leading-tight">膝前十字靭帯再建術後選手における膝関節等速性筋力とカウンタームーブメントジャンプ指標の関係</h1>

        <div id="loading" class="flex justify-center items-center h-64">
            <div class="text-lg text-gray-600">データを読み込み中...</div>
        </div>

        <div id="main-content" style="display: none;">
            <div class="bg-white rounded-lg shadow mb-6 overflow-x-auto">
                <div class="flex space-x-2 p-2">
                    <button class="tab-button active" onclick="showTab(event,'healthyinjured')">健患側比較</button>
                    <button class="tab-button" onclick="showTab(event,'correlation')">相関分析</button>
                    <button class="tab-button" onclick="showTab(event,'lsi')">LSIレーダーチャート</button>
                    <button class="tab-button" onclick="showTab(event,'table')">個人データ表</button>
                </div>
            </div>

            <div id="healthyinjured-tab" class="tab-content">
                <div class="space-y-6">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <div class="flex flex-col md:flex-row items-start md:items-center space-y-2 md:space-y-0 md:space-x-4">
                            <label class="font-semibold text-gray-700 whitespace-nowrap">変数選択:</label>
                            <select id="variable-select" class="border rounded-md px-3 py-2 text-sm w-full" onchange="updateHealthyInjuredChart()"></select>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 md:p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">健患側比較（平均値±標準偏差）</h3>
                        <div class="chart-container"><canvas id="healthyInjuredChart"></canvas></div>
                        <div id="healthyInjuredStats" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm"></div>
                    </div>
                </div>
            </div>

            <div id="correlation-tab" class="tab-content" style="display: none;">
                <div class="space-y-6">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold mb-2">相関係数ヒートマップ</h3>
                        <p class="text-xs text-gray-600 mb-4">X軸: 筋力データ, Y軸: CMJ関連データ | セルをタップして散布図を表示</p>
                        <div class="overflow-x-auto">
                            <div id="heatmap-container" class="inline-block min-w-full"></div>
                        </div>
                    </div>
                    
                    <div id="scatterplot-container" style="display: none;" class="bg-white p-4 md:p-6 rounded-lg shadow-md">
                        <div id="hover-info" class="mb-4 p-3 bg-gray-50 rounded-lg min-h-[60px]">
                            <div class="text-sm text-gray-500 italic">データポイントをタップすると詳細情報が表示されます</div>
                        </div>
                        <h3 id="scatterplot-title" class="text-lg font-semibold mb-4"></h3>
                        <div class="chart-container"><canvas id="scatterChart"></canvas></div>
                        <div id="correlation-stats" class="mt-4 p-3 bg-blue-50 rounded text-sm md:text-base"></div>
                    </div>
                </div>
            </div>

            <div id="lsi-tab" class="tab-content" style="display: none;">
                <div class="space-y-6">
                    <div class="bg-white p-4 md:p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">LSIレーダーチャート</h3>
                        <div class="chart-container" style="height: 450px;"><canvas id="radarChart"></canvas></div>
                        <div id="lsi-stats" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                    </div>
                </div>
            </div>

            <div id="table-tab" class="tab-content" style="display: none;">
                <div class="space-y-6">
                    <div class="bg-white p-4 md:p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4">個人データ一覧表</h3>
                        <div class="overflow-x-auto">
                            <div id="data-table"></div>
                        </div>
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 text-xs md:text-sm">
                            <div class="p-3 bg-blue-50 rounded-md"><h4 class="font-semibold text-blue-800 mb-1">凡例</h4><p class="text-blue-700">健: 健側の値<br/>患: 患側の値<br/>LSI: 患側÷健側×100</p></div>
                            <div class="p-3 bg-green-50 rounded-md"><h4 class="font-semibold text-green-800 mb-1">LSI評価</h4><p class="text-green-700">90-110%: 緑 <br/>&lt;90%: 赤　<br/>&gt;110%: オレンジ </p></div>
                            <div class="p-3 bg-gray-50 rounded-md"><h4 class="font-semibold text-gray-800 mb-1">データサマリー</h4><div id="table-summary" class="text-gray-700"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let charts = {};
        let selectedCorrelation = null;
        const numericColumns = [
            '伸展（60deg/sec)', '伸展（180deg/sec)', '屈曲（60deg/sec)', '屈曲（180deg/sec)',
            '跳躍高(片脚)', '滞空時間(片脚)', '減速局面力積(片脚)', '推進局面力積(片脚)',
            '減速局面力積(両足)', '推進局面力積(両足)'
        ];
        const xAxisColumns = ['伸展（60deg/sec)', '伸展（180deg/sec)', '屈曲（60deg/sec)', '屈曲（180deg/sec)'];
        const yAxisColumns = ['跳躍高(片脚)', '滞空時間(片脚)', '減速局面力積(片脚)', '推進局面力積(片脚)', '減速局面力積(両足)', '推進局面力積(両足)'];
        const lsiVariables = ['伸展（180deg/sec)', '屈曲（180deg/sec)', '減速局面力積(片脚)', '推進局面力積(片脚)', '減速局面力積(両足)', '推進局面力積(両足)'];

        window.onload = function() {
            try {
                initializeUI();
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            } catch (e) {
                console.error(e);
                document.getElementById('loading').innerHTML = '<div class="text-lg text-red-600">初期化中にエラーが発生しました。</div>';
            }
        };

        function showTab(e, tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName + '-tab').style.display = 'block';
            e.currentTarget.classList.add('active');
        }

        function initializeUI() {
            const select = document.getElementById('variable-select');
            numericColumns.forEach(col => {
                const o = document.createElement('option');
                o.value = col;
                o.textContent = col;
                select.appendChild(o);
            });
            select.value = '伸展（180deg/sec)';
            updateHealthyInjuredChart();
            createHeatmap();
            updateLSIRadar();
            createDataTable();
        }

        function processHealthyInjuredData(variable) {
            const healthy = data.filter(r => r.Side === 'Non' && typeof r[variable] === 'number');
            const injured = data.filter(r => r.Side === 'Injured' && typeof r[variable] === 'number');
            if (!healthy.length || !injured.length) return {
                barData: [],
                healthyData: [],
                injuredData: []
            };
            const h = healthy.map(r => r[variable]),
                i = injured.map(r => r[variable]);
            const hm = h.reduce((s, v) => s + v, 0) / h.length,
                im = i.reduce((s, v) => s + v, 0) / i.length;
            const hs = Math.sqrt(h.reduce((s, v) => s + Math.pow(v - hm, 2), 0) / h.length);
            const is = Math.sqrt(i.reduce((s, v) => s + Math.pow(v - im, 2), 0) / i.length);
            return {
                barData: [{
                    name: '健側',
                    value: hm,
                    error: hs
                }, {
                    name: '患側',
                    value: im,
                    error: is
                }],
                healthyData: healthy,
                injuredData: injured
            };
        }

        function updateHealthyInjuredChart() {
            const variable = document.getElementById('variable-select').value;
            const p = processHealthyInjuredData(variable);
            const ctx = document.getElementById('healthyInjuredChart').getContext('2d');
            if (charts.healthyInjured) charts.healthyInjured.destroy();
            charts.healthyInjured = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: p.barData.map(d => d.name),
                    datasets: [{
                        label: '平均値',
                        data: p.barData.map(d => d.value),
                        backgroundColor: ['#3b82f6', '#ef4444'],
                        borderColor: ['#1e40af', '#dc2626'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: variable + ' 健患側比較'
                        }
                    }
                }
            });
            const s = document.getElementById('healthyInjuredStats');
            s.innerHTML = `
                <div>
                    <h4 class="font-semibold mb-2 text-gray-800">統計値</h4>
                    ${p.barData.map(item => `
                        <div class="flex justify-between p-2 bg-gray-50 rounded mb-1">
                            <span class="text-gray-700">${item.name}:</span>
                            <span class="font-medium text-gray-900">${item.value.toFixed(2)} ± ${item.error.toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
                <div>
                    <h4 class="font-semibold mb-2 text-gray-800">データ詳細</h4>
                    <div class="p-2 bg-blue-50 rounded text-xs text-blue-700">
                        <p>健側データ数: ${p.healthyData.length}件</p>
                        <p>患側データ数: ${p.injuredData.length}件</p>
                    </div>
                </div>
            `;
        }

        function calculateCorrelation(x, y) {
            const n = x.length;
            if (!n) return 0;
            const mx = x.reduce((s, v) => s + v, 0) / n,
                my = y.reduce((s, v) => s + v, 0) / n;
            const num = x.reduce((s, v, i) => s + (v - mx) * (y[i] - my), 0);
            const den = Math.sqrt(x.reduce((s, v) => s + Math.pow(v - mx, 2), 0) * y.reduce((s, v) => s + Math.pow(v - my, 2), 0));
            return den === 0 ? 0 : num / den;
        }

        function createHeatmap() {
            const container = document.getElementById('heatmap-container');
            let html = '<div class="flex flex-col min-w-[600px]">';
            html += '<div class="flex mb-2"><div class="w-32"></div>';
            xAxisColumns.forEach(col => {
                html += `<div class="w-[100px] text-xs font-semibold text-center px-1">${col.replace(/（/g, '(').replace(/）/g, ')')}</div>`;
            });
            html += '</div>';

            yAxisColumns.forEach(yCol => {
                html += '<div class="flex items-center">';
                html += `<div class="w-32 text-xs font-semibold text-right pr-2 whitespace-nowrap">${yCol.replace(/（/g, '(').replace(/）/g, ')')}</div>`;
                xAxisColumns.forEach(xCol => {
                    const valid = data.filter(r => typeof r[xCol] === 'number' && typeof r[yCol] === 'number' && !isNaN(r[xCol]) && !isNaN(r[yCol]));
                    const vx = valid.map(r => r[xCol]),
                        vy = valid.map(r => r[yCol]);
                    const r = calculateCorrelation(vx, vy);
                    const opacity = Math.abs(r) * 0.8,
                        color = `rgba(239, 68, 68, ${opacity})`,
                        textColor = Math.abs(r) > 0.5 ? 'white' : 'black';
                    html += `<div class="heatmap-cell" style="background-color:${color};color:${textColor};" onclick="showScatterPlot('${xCol}','${yCol}',${r})" title="${xCol} vs ${yCol}: r=${r.toFixed(3)}">${r.toFixed(2)}</div>`;
                });
                html += '</div>';
            });
            html += '<div class="text-center mt-2"><div class="text-sm font-semibold text-gray-700">筋力データ (X軸)</div></div></div>';
            container.innerHTML = html;
        }

        function showScatterPlot(xCol, yCol, correlation) {
            selectedCorrelation = {
                colX: xCol,
                colY: yCol,
                value: correlation
            };
            document.getElementById('scatterplot-container').style.display = 'block';
            document.getElementById('scatterplot-title').textContent = `散布図: ${xCol} vs ${yCol}`;
            const valid = data.filter(r => typeof r[xCol] === 'number' && typeof r[yCol] === 'number' && !isNaN(r[xCol]) && !isNaN(r[yCol]));
            const ctx = document.getElementById('scatterChart').getContext('2d');
            if (charts.scatter) charts.scatter.destroy();
            const datasets = [{
                label: '男性・健側',
                data: valid.filter(r => r.Gender === 'M' && r.Side === 'Non').map(r => ({
                    x: r[xCol],
                    y: r[yCol],
                    meta: r
                })),
                backgroundColor: '#3b82f6',
                pointRadius: 6
            }, {
                label: '男性・患側',
                data: valid.filter(r => r.Gender === 'M' && r.Side === 'Injured').map(r => ({
                    x: r[xCol],
                    y: r[yCol],
                    meta: r
                })),
                backgroundColor: '#f59e0b',
                pointRadius: 6
            }, {
                label: '女性・健側',
                data: valid.filter(r => r.Gender === 'F' && r.Side === 'Non').map(r => ({
                    x: r[xCol],
                    y: r[yCol],
                    meta: r
                })),
                backgroundColor: '#10b981',
                pointRadius: 6
            }, {
                label: '女性・患側',
                data: valid.filter(r => r.Gender === 'F' && r.Side === 'Injured').map(r => ({
                    x: r[xCol],
                    y: r[yCol],
                    meta: r
                })),
                backgroundColor: '#ef4444',
                pointRadius: 6
            }];
            charts.scatter = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xCol
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yCol
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: (c) => {
                                    const p = c[0].raw;
                                    return `選手${p.meta.ID} | ${p.meta.Side==='Non'?'健側':'患側'} | 術式: ${p.meta.Ope}`;
                                },
                                label: (c) => {
                                    const p = c.raw;
                                    return [`${xCol}: ${p.x.toFixed(2)}`, `${yCol}: ${p.y.toFixed(2)}`, `性別: ${p.meta.Gender==='M'?'男性':'女性'}`];
                                }
                            }
                        }
                    }
                }
            });
            const xValues = valid.map(r => r[xCol]),
                yValues = valid.map(r => r[yCol]);
            const reg = calculateRegressionLine(xValues, yValues);
            document.getElementById('correlation-stats').innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><span class="font-semibold text-gray-800">相関係数 (r):</span> <span class="text-blue-600">${correlation.toFixed(3)}</span></div>
                    <div><span class="font-semibold text-gray-800">データ数:</span> ${valid.length}件</div>
                    ${reg?`<div><span class="font-semibold text-gray-800">回帰式:</span> <span class="text-blue-600">y = ${reg.slope.toFixed(3)}x + ${reg.intercept.toFixed(3)}</span></div>`:''}
                </div>
            `;
        }

        function calculateRegressionLine(x, y) {
            const n = x.length;
            if (!n) return null;
            const sx = x.reduce((s, v) => s + v, 0),
                sy = y.reduce((s, v) => s + v, 0),
                sxy = x.reduce((s, v, i) => s + v * y[i], 0),
                sxx = x.reduce((s, v) => s + v * v, 0);
            const slope = (n * sxy - sx * sy) / (n * sxx - sx * sx);
            const intercept = (sy - slope * sx) / n;
            return {
                slope,
                intercept
            };
        }

        function processLSIData() {
            const ids = [...new Set(data.map(r => r.ID))].sort();
            const individual = ids.map(id => {
                const h = data.find(r => r.ID === id && r.Side === 'Non');
                const inj = data.find(r => r.ID === id && r.Side === 'Injured');
                if (!h || !inj) return null;
                const o = {
                    patientId: id,
                    gender: h.Gender
                };
                lsiVariables.forEach(v => {
                    const hv = h[v],
                        iv = inj[v];
                    o[v] = (typeof hv === 'number' && typeof iv === 'number' && hv !== 0) ? (iv / hv) * 100 : 0;
                });
                return o;
            }).filter(Boolean);
            const average = {};
            lsiVariables.forEach(v => {
                const vals = individual.map(p => p[v]).filter(x => x > 0);
                average[v] = vals.length ? vals.reduce((s, v) => s + v, 0) / vals.length : 0;
            });
            return {
                individualLSIData: individual,
                averageLSI: average
            };
        }

        function updateLSIRadar() {
            const {
                individualLSIData,
                averageLSI
            } = processLSIData();
            const ctx = document.getElementById('radarChart').getContext('2d');
            if (charts.radar) charts.radar.destroy();
            const labels = lsiVariables.map(v => v.replace(/（/g, '(').replace(/）/g, ')'));
            const avg = lsiVariables.map(v => averageLSI[v]);
            const datasets = [];
            individualLSIData.forEach(p => {
                datasets.push({
                    label: `選手${p.patientId}`,
                    data: lsiVariables.map(v => p[v]),
                    borderColor: p.gender === 'M' ? '#93c5fd' : '#fbb6ce',
                    backgroundColor: p.gender === 'M' ? 'rgba(147,197,253,0.1)' : 'rgba(251,182,206,0.1)',
                    borderWidth: 1,
                    pointRadius: 2
                });
            });
            datasets.push({
                label: '全体平均',
                data: avg,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239,68,68,0.2)',
                borderWidth: 3,
                pointRadius: 6,
                pointBackgroundColor: '#ef4444'
            });
            charts.radar = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels,
                    datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            min: 0,
                            max: 150,
                            ticks: {
                                stepSize: 30
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                filter: (li) => li.text === '全体平均'
                            }
                        }
                    }
                }
            });
            const stats = document.getElementById('lsi-stats');
            const male = individualLSIData.filter(p => p.gender === 'M').length,
                female = individualLSIData.filter(p => p.gender === 'F').length;
            stats.innerHTML = `
                <div>
                    <h4 class="text-lg font-semibold mb-3">全体平均LSI値</h4>
                    <div class="space-y-2">
                        ${lsiVariables.map(v => {
                            const val = averageLSI[v];
                            const cls = val < 90 ? 'text-red-600' : (val > 110 ? 'text-orange-600' : 'text-green-600');
                            return `
                                <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                    <span class="text-sm font-medium">${v.replace(/（/g,'(').replace(/）/g,')')}</span>
                                    <span class="text-sm font-bold ${cls}">${val.toFixed(1)}%</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-3">凡例・基準値</h4>
                    <div class="space-y-3">
                        <div>
                            <div class="flex items-center space-x-2 mb-2"><div class="w-4 h-1 bg-red-500"></div><span class="text-sm font-medium">全体平均（太線）</span></div>
                            <div class="flex items-center space-x-2 mb-2"><div class="w-4 h-1 bg-blue-300"></div><span class="text-sm">男性各個人データ（青）</span></div>
                            <div class="flex items-center space-x-2 mb-4"><div class="w-4 h-1 bg-pink-300"></div><span class="text-sm">女性各個人データ（ピンク）</span></div>
                        </div>
                        <div class="mt-4">
                            <h5 class="text-sm font-semibold mb-2">個人データ詳細</h5>
                            <div class="text-xs">
                                <p>対象者数: ${individualLSIData.length}名</p>
                                <p>男性: ${male}名</p>
                                <p>女性: ${female}名</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createDataTable() {
            const ids = [...new Set(data.map(r => r.ID))].sort();
            const rows = ids.map(id => {
                const h = data.find(r => r.ID === id && r.Side === 'Non');
                const inj = data.find(r => r.ID === id && r.Side === 'Injured');
                if (!h || !inj) return null;
                const obj = {
                    id,
                    gender: h.Gender,
                    ope: h.Ope,
                    competition: h.Competition,
                    variables: {}
                };
                numericColumns.forEach(v => {
                    const hv = h[v] || 0,
                        iv = inj[v] || 0;
                    const l = (typeof hv === 'number' && typeof iv === 'number' && hv !== 0) ? (iv / hv) * 100 : 0;
                    obj.variables[v] = {
                        healthy: hv,
                        injured: iv,
                        lsi: l
                    };
                });
                return obj;
            }).filter(Boolean);

            let html = '<div class="table-container"><table class="min-w-full border-collapse border border-gray-300 text-xs md:text-sm">';
            html += '<thead><tr class="bg-gray-100 sticky-header">';
            html += '<th class="border border-gray-300 px-2 py-3 text-center font-semibold">ID</th>';
            html += '<th class="border border-gray-300 px-2 py-3 text-center font-semibold">性別</th>';
            html += '<th class="border border-gray-300 px-2 py-3 text-center font-semibold whitespace-nowrap">術式</th>';
            html += '<th class="border border-gray-300 px-2 py-3 text-center font-semibold">競技</th>';
            numericColumns.forEach(v => {
                html += `<th class="border border-gray-300 px-2 py-3 text-center font-semibold min-w-[100px] whitespace-nowrap">${v.replace(/（/g, '(').replace(/）/g, ')')}</th>`;
            });
            html += '</tr></thead><tbody>';

            rows.forEach((p, i) => {
                const bg = i % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                html += `<tr class="${bg}">`;
                html += `<td class="border border-gray-300 px-2 py-3 text-center font-medium">${p.id}</td>`;
                html += `<td class="border border-gray-300 px-2 py-3 text-center">${p.gender==='M'?'男性':'女性'}</td>`;
                html += `<td class="border border-gray-300 px-2 py-3 text-center">${p.ope}</td>`;
                html += `<td class="border border-gray-300 px-2 py-3 text-center">${p.competition}</td>`;
                numericColumns.forEach(v => {
                    const d = p.variables[v];
                    const cls = d.lsi < 90 ? 'text-red-700 bg-red-100' : (d.lsi > 110 ? 'text-orange-700 bg-orange-100' : 'text-green-700 bg-green-100');
                    html += `
                        <td class="border border-gray-300 px-1 py-1 text-center">
                            <div class="space-y-1">
                                <div class="text-[10px] text-blue-600">健: ${Number(d.healthy).toFixed(2)}</div>
                                <div class="text-[10px] text-red-600">患: ${Number(d.injured).toFixed(2)}</div>
                                <div class="text-[10px] font-semibold ${cls} px-1 rounded">LSI: ${Number(d.lsi).toFixed(0)}%</div>
                            </div>
                        </td>
                    `;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            document.getElementById('data-table').innerHTML = html;

            const male = rows.filter(p => p.gender === 'M').length,
                female = rows.filter(p => p.gender === 'F').length;
            document.getElementById('table-summary').innerHTML = `<p class="text-gray-700">対象者数: ${rows.length}名<br/>男性: ${male}名<br/>女性: ${female}名</p>`;
        }
    </script>
</body>
</html>
